<a name=top></a><!doctype html>
<html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>郝鸿涛：Hongtao Hao</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/fonts.css>
<link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css rel=stylesheet>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/bash.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/python.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/vega@5.17.0></script>
<script src=https://cdn.jsdelivr.net/npm/vega-lite@4.17.0></script>
<script src=https://cdn.jsdelivr.net/npm/vega-embed@6.12.2></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel=icon href=https://hongtaoh.com/ht10.ico>
</head>
<body>
<div class=wrapper>
<header class=header>
<nav class=nav>
<a href=/ class=nav-logo>
<img src=/media/ht10.png width=50 height=50 alt="Hongtao Hao">
</a>
<ul class=nav-links>
<li><a href=/>Home</a></li>
<li><a href=/en/vitae/>Vitae</a></li>
<li><a href=/en/projects/>Projects</a></li>
<li><a href=/en/research/>Research</a></li>
<li><a href=/en/blog/>Blog</a></li>
<li><a href=/en/apad/>APAD</a></li>
<li><a href=/cn/blog/>中文</a></li>
</ul>
</nav>
</header>
<main class=content role=main>
<div style=text-align:center>
<h1>Basic Data Wrangling and Plotting Tutorial</h1>
<p>Hongtao Hao
/ 2022-10-05 </p>
<hr>
</div>
<span class=article-toolbar>
<a href=https://github.com/hongtaoh/hongtaoh.github.io/edit/sources/content/en/blog/2022-10-05-wrangling.md style=font-size:24px;color:#000 target=_blank><i class="fa fa-edit" aria-hidden=true title="Suggest an edit of this page"></i>
</a>
</span>
<aside class=toc>
Table of Contents:
<nav id=TableOfContents>
<ul>
<li><a href=#data-import-and-basic-manipulation>Data import and basic manipulation</a></li>
<li><a href=#task-1>Task 1</a></li>
<li><a href=#task-2>Task 2</a></li>
</ul>
</nav>
</aside>
<div class="body-text list-text">
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>pandas</span> <span style=color:green;font-weight:700>as</span> <span style=color:#00f;font-weight:700>pd</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>numpy</span> <span style=color:green;font-weight:700>as</span> <span style=color:#00f;font-weight:700>np</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>matplotlib.pyplot</span> <span style=color:green;font-weight:700>as</span> <span style=color:#00f;font-weight:700>plt</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>seaborn</span> <span style=color:green;font-weight:700>as</span> <span style=color:#00f;font-weight:700>sns</span>
<span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>altair</span> <span style=color:green;font-weight:700>as</span> <span style=color:#00f;font-weight:700>alt</span>
</code></pre></div><p>Download data here: <a href=/files/aiddata.csv>aiddata.csv</a>
</p>
<h2 id=data-import-and-basic-manipulation>Data import and basic manipulation<a href=#data-import-and-basic-manipulation class=header-anchor arialabel=Anchor> # </a></h2>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>df <span style=color:#666>=</span> pd<span style=color:#666>.</span>read_csv(<span style=color:#ba2121>&#39;../static/files/aiddata.csv&#39;</span>)
<span style=color:#408080;font-style:italic># df.head()</span>
</code></pre></div><p><img src=/en/blog/2022-10-05-wrangling_files/df_1.png alt></p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># don&#39;t actually need the first two columns:</span>
df <span style=color:#666>=</span> df<span style=color:#666>.</span>iloc[:, <span style=color:#666>2</span>:]

<span style=color:#408080;font-style:italic># rename the columns</span>
df<span style=color:#666>.</span>columns <span style=color:#666>=</span> [<span style=color:#ba2121>&#39;year&#39;</span>, <span style=color:#ba2121>&#39;donor&#39;</span>, <span style=color:#ba2121>&#39;recipient&#39;</span>, <span style=color:#ba2121>&#39;amount&#39;</span>, <span style=color:#ba2121>&#39;purpose_code&#39;</span>, <span style=color:#ba2121>&#39;purpose_name&#39;</span>]
<span style=color:#408080;font-style:italic># df.head()</span>
</code></pre></div><p><img src=/en/blog/2022-10-05-wrangling_files/df_2.png alt></p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># check the shape</span>
df<span style=color:#666>.</span>shape

<span style=color:#408080;font-style:italic># close to 10K rows!</span>
</code></pre></div><pre><code>(98540, 6)
</code></pre>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># check year range</span>

<span style=color:green>min</span>(df<span style=color:#666>.</span>year), <span style=color:green>max</span>(df<span style=color:#666>.</span>year)
</code></pre></div><pre><code>(1973, 2013)
</code></pre>
<h2 id=task-1>Task 1<a href=#task-1 class=header-anchor arialabel=Anchor> # </a></h2>
<p>The first task is: for each country or region, visualize the difference between its donation and receiving, for each year. To do that, we need a dataframe that has these three columns:</p>
<ul>
<li>year</li>
<li>country/region name</li>
<li>donation</li>
<li>receiving</li>
<li>difference</li>
</ul>
<p>Then, we can visualize the difference by year for each country or region (hereafter referred as &ldquo;country&rdquo;).</p>
<p>There are two obvious challenges:</p>
<ul>
<li>Right now, each row lists a donation-receiving pair. But what we want is: for each year, what&rsquo;s the amount of donation and receiving this country has.</li>
<li>Not all countries appeared in all years.</li>
</ul>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># We first get the donation data</span>
donation_data <span style=color:#666>=</span> []
<span style=color:green;font-weight:700>for</span> group <span style=color:#a2f;font-weight:700>in</span> df<span style=color:#666>.</span>groupby([<span style=color:#ba2121>&#39;year&#39;</span>, <span style=color:#ba2121>&#39;donor&#39;</span>]):
    <span style=color:#408080;font-style:italic># total amount of donation in that year for this country</span>
    total_yearly_donation <span style=color:#666>=</span> <span style=color:green>sum</span>(group[<span style=color:#666>1</span>]<span style=color:#666>.</span>amount)
    <span style=color:#408080;font-style:italic># year, country name, total</span>
    donation_data<span style=color:#666>.</span>append(
        (group[<span style=color:#666>0</span>][<span style=color:#666>0</span>], group[<span style=color:#666>0</span>][<span style=color:#666>1</span>], total_yearly_donation))
donation_df <span style=color:#666>=</span> pd<span style=color:#666>.</span>DataFrame(
    donation_data, columns<span style=color:#666>=</span>[<span style=color:#ba2121>&#39;year&#39;</span>,<span style=color:#ba2121>&#39;country&#39;</span>,<span style=color:#ba2121>&#39;donation&#39;</span>])
donation_df<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>donation</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Australia</td>
<td>46285863.0</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Belgium</td>
<td>39251336.0</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Canada</td>
<td>437928427.0</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>France</td>
<td>247189555.0</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>Germany</td>
<td>562232384.0</td>
</tr>
</tbody>
</table>
</div>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># Then we get the receiving data</span>
receiving_data <span style=color:#666>=</span> []
<span style=color:green;font-weight:700>for</span> group <span style=color:#a2f;font-weight:700>in</span> df<span style=color:#666>.</span>groupby([<span style=color:#ba2121>&#39;year&#39;</span>, <span style=color:#ba2121>&#39;recipient&#39;</span>]):
    <span style=color:#408080;font-style:italic># total amount of receiving in that year for this country</span>
    total_yearly_receiving <span style=color:#666>=</span> <span style=color:green>sum</span>(group[<span style=color:#666>1</span>]<span style=color:#666>.</span>amount)
    <span style=color:#408080;font-style:italic># year, country name, total</span>
    receiving_data<span style=color:#666>.</span>append(
        (group[<span style=color:#666>0</span>][<span style=color:#666>0</span>], group[<span style=color:#666>0</span>][<span style=color:#666>1</span>], total_yearly_receiving))
receiving_df <span style=color:#666>=</span> pd<span style=color:#666>.</span>DataFrame(
    receiving_data, columns<span style=color:#666>=</span>[<span style=color:#ba2121>&#39;year&#39;</span>,<span style=color:#ba2121>&#39;country&#39;</span>,<span style=color:#ba2121>&#39;receiving&#39;</span>])
receiving_df<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>receiving</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Brazil</td>
<td>3.120750e+08</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Chile</td>
<td>8.805608e+07</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Colombia</td>
<td>5.499448e+08</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>Cyprus</td>
<td>9.613414e+06</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>India</td>
<td>2.285257e+09</td>
</tr>
</tbody>
</table>
</div>
<p>First, let&rsquo;s look at how many countries are there:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>all_cntry <span style=color:#666>=</span> <span style=color:green>list</span>(df<span style=color:#666>.</span>donor) <span style=color:#666>+</span> <span style=color:green>list</span>(df<span style=color:#666>.</span>recipient)
all_cntry <span style=color:#666>=</span> <span style=color:green>list</span>(<span style=color:green>set</span>(all_cntry))

<span style=color:#408080;font-style:italic># there are in total 47 unique countries</span>
<span style=color:green>len</span>(all_cntry)
</code></pre></div><pre><code>47
</code></pre>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># We have so many countries. It&#39;s difficult to visualize them all in one plot</span>
<span style=color:#408080;font-style:italic># So I am assigning groups to countries. </span>
<span style=color:#408080;font-style:italic># Basically, I want to plot 4 countires in each figure</span>
cntry_group_list <span style=color:#666>=</span> <span style=color:green>list</span>(np<span style=color:#666>.</span>arange(<span style=color:#666>1</span>,<span style=color:#666>13</span>)) <span style=color:#666>*</span> <span style=color:#666>4</span>
<span style=color:green;font-weight:700>del</span> cntry_group_list[<span style=color:#666>-</span><span style=color:#666>1</span>]
</code></pre></div><p>We have 47 unique countries, but the problem is, in some years, not all countries are present, for example, in <code>receiving_df</code>, only 10 countries were present in the year of 1973.</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>receiving_df[receiving_df<span style=color:#666>.</span>year <span style=color:#666>==</span> <span style=color:#666>1973</span>]
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>receiving</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Brazil</td>
<td>3.120750e+08</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Chile</td>
<td>8.805608e+07</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Colombia</td>
<td>5.499448e+08</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>Cyprus</td>
<td>9.613414e+06</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>India</td>
<td>2.285257e+09</td>
</tr>
<tr>
<th>5</th>
<td>1973</td>
<td>Korea</td>
<td>1.363707e+09</td>
</tr>
<tr>
<th>6</th>
<td>1973</td>
<td>Kuwait</td>
<td>3.254830e+05</td>
</tr>
<tr>
<th>7</th>
<td>1973</td>
<td>Saudi Arabia</td>
<td>6.509700e+04</td>
</tr>
<tr>
<th>8</th>
<td>1973</td>
<td>Thailand</td>
<td>2.063634e+08</td>
</tr>
<tr>
<th>9</th>
<td>1973</td>
<td>United Arab Emirates</td>
<td>6.509700e+04</td>
</tr>
</tbody>
</table>
</div>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># same issue for donation data</span>
donation_df[donation_df<span style=color:#666>.</span>year <span style=color:#666>==</span> <span style=color:#666>1973</span>]
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>donation</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Australia</td>
<td>4.628586e+07</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Belgium</td>
<td>3.925134e+07</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Canada</td>
<td>4.379284e+08</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>France</td>
<td>2.471896e+08</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>Germany</td>
<td>5.622324e+08</td>
</tr>
<tr>
<th>5</th>
<td>1973</td>
<td>Italy</td>
<td>1.667191e+08</td>
</tr>
<tr>
<th>6</th>
<td>1973</td>
<td>Japan</td>
<td>9.389659e+08</td>
</tr>
<tr>
<th>7</th>
<td>1973</td>
<td>Netherlands</td>
<td>1.627509e+08</td>
</tr>
<tr>
<th>8</th>
<td>1973</td>
<td>Norway</td>
<td>3.587485e+07</td>
</tr>
<tr>
<th>9</th>
<td>1973</td>
<td>Sweden</td>
<td>1.683693e+08</td>
</tr>
<tr>
<th>10</th>
<td>1973</td>
<td>Switzerland</td>
<td>1.406094e+07</td>
</tr>
<tr>
<th>11</th>
<td>1973</td>
<td>United Kingdom</td>
<td>4.425792e+08</td>
</tr>
<tr>
<th>12</th>
<td>1973</td>
<td>United States</td>
<td>1.553264e+09</td>
</tr>
</tbody>
</table>
</div>
<p>This is how I solved the problem:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>donation_dfs <span style=color:#666>=</span> []
<span style=color:green;font-weight:700>for</span> group <span style=color:#a2f;font-weight:700>in</span> donation_df<span style=color:#666>.</span>groupby(<span style=color:#ba2121>&#39;year&#39;</span>):
    year <span style=color:#666>=</span> group[<span style=color:#666>0</span>]
    present_cntry <span style=color:#666>=</span> group[<span style=color:#666>1</span>]<span style=color:#666>.</span>country<span style=color:#666>.</span>tolist()
    absent_cntry <span style=color:#666>=</span> [x <span style=color:green;font-weight:700>for</span> x <span style=color:#a2f;font-weight:700>in</span> all_cntry <span style=color:green;font-weight:700>if</span> x <span style=color:#a2f;font-weight:700>not</span> <span style=color:#a2f;font-weight:700>in</span> present_cntry]
    absent_df <span style=color:#666>=</span> pd<span style=color:#666>.</span>DataFrame({
        <span style=color:#ba2121>&#39;year&#39;</span>: year,
        <span style=color:#ba2121>&#39;country&#39;</span>: absent_cntry,
        <span style=color:#ba2121>&#39;donation&#39;</span>: <span style=color:#666>0</span>
    })
    dff <span style=color:#666>=</span> pd<span style=color:#666>.</span>concat([group[<span style=color:#666>1</span>], absent_df], ignore_index <span style=color:#666>=</span> <span style=color:green;font-weight:700>True</span>)
    
    dff<span style=color:#666>.</span>sort_values(by<span style=color:#666>=</span><span style=color:#ba2121>&#39;country&#39;</span>, ascending<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>, inplace<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>)
    dff[<span style=color:#ba2121>&#39;group&#39;</span>] <span style=color:#666>=</span> cntry_group_list
    donation_dfs<span style=color:#666>.</span>append(dff)
donation <span style=color:#666>=</span> pd<span style=color:#666>.</span>concat(donation_dfs, ignore_index <span style=color:#666>=</span> <span style=color:green;font-weight:700>True</span>)
donation<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>donation</th>
<th>group</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Australia</td>
<td>46285863.0</td>
<td>1</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Austria</td>
<td>0.0</td>
<td>2</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Belgium</td>
<td>39251336.0</td>
<td>3</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>Brazil</td>
<td>0.0</td>
<td>4</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>Canada</td>
<td>437928427.0</td>
<td>5</td>
</tr>
</tbody>
</table>
</div>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>receiving_dfs <span style=color:#666>=</span> []
<span style=color:green;font-weight:700>for</span> group <span style=color:#a2f;font-weight:700>in</span> receiving_df<span style=color:#666>.</span>groupby(<span style=color:#ba2121>&#39;year&#39;</span>):
    year <span style=color:#666>=</span> group[<span style=color:#666>0</span>]
    present_cntry <span style=color:#666>=</span> group[<span style=color:#666>1</span>]<span style=color:#666>.</span>country<span style=color:#666>.</span>tolist()
    absent_cntry <span style=color:#666>=</span> [x <span style=color:green;font-weight:700>for</span> x <span style=color:#a2f;font-weight:700>in</span> all_cntry <span style=color:green;font-weight:700>if</span> x <span style=color:#a2f;font-weight:700>not</span> <span style=color:#a2f;font-weight:700>in</span> present_cntry]
    absent_df <span style=color:#666>=</span> pd<span style=color:#666>.</span>DataFrame({
        <span style=color:#ba2121>&#39;year&#39;</span>: year,
        <span style=color:#ba2121>&#39;country&#39;</span>: absent_cntry,
        <span style=color:#ba2121>&#39;receiving&#39;</span>: <span style=color:#666>0</span>
    })
    dff <span style=color:#666>=</span> pd<span style=color:#666>.</span>concat([group[<span style=color:#666>1</span>], absent_df], ignore_index <span style=color:#666>=</span> <span style=color:green;font-weight:700>True</span>)
    dff<span style=color:#666>.</span>sort_values(by<span style=color:#666>=</span><span style=color:#ba2121>&#39;country&#39;</span>, ascending<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>, inplace<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>)
    dff[<span style=color:#ba2121>&#39;group&#39;</span>] <span style=color:#666>=</span> cntry_group_list
    receiving_dfs<span style=color:#666>.</span>append(dff)
receiving <span style=color:#666>=</span> pd<span style=color:#666>.</span>concat(receiving_dfs, ignore_index <span style=color:#666>=</span> <span style=color:green;font-weight:700>True</span>)
receiving<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>receiving</th>
<th>group</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Australia</td>
<td>0.0</td>
<td>1</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Austria</td>
<td>0.0</td>
<td>2</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Belgium</td>
<td>0.0</td>
<td>3</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>Brazil</td>
<td>312075045.0</td>
<td>4</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>Canada</td>
<td>0.0</td>
<td>5</td>
</tr>
</tbody>
</table>
</div>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># to check whether the countries in the two lists are the same</span>
r_c <span style=color:#666>=</span> <span style=color:green>list</span>(<span style=color:green>set</span>(receiving<span style=color:#666>.</span>country))
d_c <span style=color:#666>=</span> <span style=color:green>list</span>(<span style=color:green>set</span>(donation<span style=color:#666>.</span>country))
r_c <span style=color:#666>==</span> d_c
</code></pre></div><pre><code>True
</code></pre>
<p>Then we combine the two datasets and calculate the difference:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>all_df <span style=color:#666>=</span> donation
all_df[<span style=color:#ba2121>&#39;receiving&#39;</span>] <span style=color:#666>=</span> receiving[<span style=color:#ba2121>&#39;receiving&#39;</span>]
all_df[<span style=color:#ba2121>&#39;d_minus_r&#39;</span>] <span style=color:#666>=</span> all_df[<span style=color:#ba2121>&#39;donation&#39;</span>] <span style=color:#666>-</span> all_df[<span style=color:#ba2121>&#39;receiving&#39;</span>]
all_df<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>country</th>
<th>donation</th>
<th>group</th>
<th>receiving</th>
<th>d_minus_r</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1973</td>
<td>Australia</td>
<td>46285863.0</td>
<td>1</td>
<td>0.0</td>
<td>46285863.0</td>
</tr>
<tr>
<th>1</th>
<td>1973</td>
<td>Austria</td>
<td>0.0</td>
<td>2</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2</th>
<td>1973</td>
<td>Belgium</td>
<td>39251336.0</td>
<td>3</td>
<td>0.0</td>
<td>39251336.0</td>
</tr>
<tr>
<th>3</th>
<td>1973</td>
<td>Brazil</td>
<td>0.0</td>
<td>4</td>
<td>312075045.0</td>
<td>-312075045.0</td>
</tr>
<tr>
<th>4</th>
<td>1973</td>
<td>Canada</td>
<td>437928427.0</td>
<td>5</td>
<td>0.0</td>
<td>437928427.0</td>
</tr>
</tbody>
</table>
</div>
<p>To make the plot, we need to transform the format of year:</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>all_df[<span style=color:#ba2121>&#39;year&#39;</span>] <span style=color:#666>=</span> pd<span style=color:#666>.</span>to_datetime(all_df[<span style=color:#ba2121>&#39;year&#39;</span>], <span style=color:green>format</span><span style=color:#666>=</span><span style=color:#ba2121>&#39;%Y&#39;</span>)
</code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># We only plot group 1, for simplicity</span>
group1 <span style=color:#666>=</span> all_df[all_df<span style=color:#666>.</span>group <span style=color:#666>==</span> <span style=color:#666>1</span>]
</code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>alt<span style=color:#666>.</span>Chart(group1)<span style=color:#666>.</span>mark_line()<span style=color:#666>.</span>encode(
    x<span style=color:#666>=</span><span style=color:#ba2121>&#39;year:T&#39;</span>,
    y <span style=color:#666>=</span> alt<span style=color:#666>.</span>Y(
        <span style=color:#ba2121>&#39;d_minus_r:Q&#39;</span>,
        title <span style=color:#666>=</span> <span style=color:#ba2121>&#39;Donation minus receiving&#39;</span>
    ),
    color<span style=color:#666>=</span><span style=color:#ba2121>&#39;country:N&#39;</span>,
    strokeDash<span style=color:#666>=</span><span style=color:#ba2121>&#39;country:N&#39;</span>
)
</code></pre></div>
<p><img src=/en/blog/2022-10-05-wrangling_files/diff_country_year.png alt></p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>plt<span style=color:#666>.</span>figure(figsize<span style=color:#666>=</span>(<span style=color:#666>10</span>,<span style=color:#666>8</span>))
ax <span style=color:#666>=</span> sns<span style=color:#666>.</span>lineplot(x<span style=color:#666>=</span><span style=color:#ba2121>&#39;year&#39;</span>, y<span style=color:#666>=</span><span style=color:#ba2121>&#39;d_minus_r&#39;</span>, hue<span style=color:#666>=</span><span style=color:#ba2121>&#39;country&#39;</span>, data <span style=color:#666>=</span> group1)
ax<span style=color:#666>.</span>set(ylabel<span style=color:#666>=</span><span style=color:#ba2121>&#39;Donation minus receiving&#39;</span>)
</code></pre></div><pre><code>[Text(0, 0.5, 'Donation minus receiving')]
</code></pre>
<p><img src=/en/blog/2022-10-05-wrangling_files/2022-10-05-wrangling_30_1.png alt=png></p>
<h2 id=task-2>Task 2<a href=#task-2 class=header-anchor arialabel=Anchor> # </a></h2>
<p>The second task is: find the top 10 coalesced purposes (according to the amount of donation) and for these ten purposes, show how their amount changes by time.</p>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># First, find the top ten purposes</span>
top_purpose_df <span style=color:#666>=</span> df<span style=color:#666>.</span>groupby(<span style=color:#ba2121>&#39;purpose_name&#39;</span>)[<span style=color:#ba2121>&#39;amount&#39;</span>]<span style=color:#666>.</span>agg(<span style=color:#ba2121>&#39;sum&#39;</span>)<span style=color:#666>.</span>nlargest(n<span style=color:#666>=</span><span style=color:#666>10</span>)
top_10_purposes <span style=color:#666>=</span> <span style=color:green>list</span>(top_purpose_df<span style=color:#666>.</span>index)
top_10_purposes
</code></pre></div><pre><code>['Air transport',
 'Rail transport',
 'Industrial development',
 'Power generation/non-renewable sources',
 'RESCHEDULING AND REFINANCING',
 'Import support (capital goods)',
 'Social/ welfare services',
 'Telecommunications',
 'Power generation/renewable sources',
 'Sectors not specified']
</code></pre>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># Then select only data involving these top purposes</span>
<span style=color:#408080;font-style:italic># We only want three columns: year, amount, and purpose name</span>
purpose_df <span style=color:#666>=</span> df[df<span style=color:#666>.</span>purpose_name<span style=color:#666>.</span>isin(top_10_purposes)][[<span style=color:#ba2121>&#39;year&#39;</span>, <span style=color:#ba2121>&#39;amount&#39;</span>, <span style=color:#ba2121>&#39;purpose_name&#39;</span>]]
<span style=color:#408080;font-style:italic># So many rows:</span>
purpose_df<span style=color:#666>.</span>shape
</code></pre></div><pre><code>(17793, 3)
</code></pre>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>purpose_df<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>amount</th>
<th>purpose_name</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1977</td>
<td>348718518.0</td>
<td>Power generation/renewable sources</td>
</tr>
<tr>
<th>2</th>
<td>1983</td>
<td>79371799.0</td>
<td>Rail transport</td>
</tr>
<tr>
<th>3</th>
<td>1984</td>
<td>212202942.0</td>
<td>Rail transport</td>
</tr>
<tr>
<th>11</th>
<td>1976</td>
<td>193588873.0</td>
<td>Power generation/renewable sources</td>
</tr>
<tr>
<th>19</th>
<td>1986</td>
<td>53561256.0</td>
<td>Power generation/renewable sources</td>
</tr>
</tbody>
</table>
</div>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># For each purpose, we calculate the yearly sum:</span>
purpose_dfs <span style=color:#666>=</span> []
<span style=color:green;font-weight:700>for</span> group <span style=color:#a2f;font-weight:700>in</span> purpose_df<span style=color:#666>.</span>groupby(<span style=color:#ba2121>&#39;purpose_name&#39;</span>):
    purpose_name <span style=color:#666>=</span> group[<span style=color:#666>0</span>]
    group_df <span style=color:#666>=</span> group[<span style=color:#666>1</span>]<span style=color:#666>.</span>groupby(<span style=color:#ba2121>&#39;year&#39;</span>)[<span style=color:#ba2121>&#39;amount&#39;</span>]<span style=color:#666>.</span>sum()<span style=color:#666>.</span>to_frame()
    group_df<span style=color:#666>.</span>reset_index(inplace<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>)
    group_df[<span style=color:#ba2121>&#39;purpose_name&#39;</span>] <span style=color:#666>=</span> group[<span style=color:#666>0</span>]
    purpose_dfs<span style=color:#666>.</span>append(group_df)
purpose <span style=color:#666>=</span> pd<span style=color:#666>.</span>concat(purpose_dfs, ignore_index <span style=color:#666>=</span> <span style=color:green;font-weight:700>True</span>)
purpose<span style=color:#666>.</span>head()
</code></pre></div><div>
<style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}<pre><code>.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</code></pre><p></style></p>
<table border=1 class=dataframe>
<thead>
<tr style=text-align:right>
<th></th>
<th>year</th>
<th>amount</th>
<th>purpose_name</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1974</td>
<td>1.525672e+07</td>
<td>Air transport</td>
</tr>
<tr>
<th>1</th>
<td>1975</td>
<td>1.582943e+07</td>
<td>Air transport</td>
</tr>
<tr>
<th>2</th>
<td>1977</td>
<td>7.046280e+05</td>
<td>Air transport</td>
</tr>
<tr>
<th>3</th>
<td>1979</td>
<td>7.342023e+07</td>
<td>Air transport</td>
</tr>
<tr>
<th>4</th>
<td>1980</td>
<td>3.088275e+09</td>
<td>Air transport</td>
</tr>
</tbody>
</table>
</div>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>purpose<span style=color:#666>.</span>shape
</code></pre></div><pre><code>(338, 3)
</code></pre>
<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#408080;font-style:italic># make the plot</span>
alt<span style=color:#666>.</span>Chart(purpose)<span style=color:#666>.</span>mark_line()<span style=color:#666>.</span>encode(
    x <span style=color:#666>=</span> <span style=color:#ba2121>&#39;year&#39;</span>,
    y <span style=color:#666>=</span> <span style=color:#ba2121>&#39;amount&#39;</span>,
    color <span style=color:#666>=</span> <span style=color:#ba2121>&#39;purpose_name&#39;</span>,
    strokeDash <span style=color:#666>=</span> <span style=color:#ba2121>&#39;purpose_name&#39;</span>
)
</code></pre></div>
<p><img src=/en/blog/2022-10-05-wrangling_files/purpose_by_year.png alt></p>
<a href=https://hongtaoh.com/tags/ds/>#DS</a>
<p style=color:#777>Last modified on 2022-10-15</p>
</div>
<a href=#top><i class="fa fa-chevron-up" style=font-size:30px;color:#000></i></a>
</main>
<footer class=footer>
<script src=https://utteranc.es/client.js repo=hongtaoh/hongtaoh.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script>
<script type=text/javascript src=/js/math-code.js></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type=text/javascript src=/js/center-img.js></script>
<ul class=footer-links>
<li><a href=/en/blog/index.xml type=application/rss+xml title="RSS feed">
Subscribe </a>
</li>
<li>
<a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>
License
<i class="fa fa-cc" aria-hidden=true title="Attribution-NonCommercial-ShareAlike 4.0 International"></i>
</a>
</li>
</ul>
<div class=copyright-text>
©
Hongtao Hao
2020-2022
</div>
</footer>